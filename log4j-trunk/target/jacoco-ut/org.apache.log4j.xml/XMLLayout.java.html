<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>XMLLayout.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache Log4j</a> &gt; <a href="index.source.html" class="el_package">org.apache.log4j.xml</a> &gt; <span class="el_source">XMLLayout.java</span></div><h1>XMLLayout.java</h1><pre class="source lang-java linenums">/*
 * Licensed to the Apache Software Foundation (ASF) under one or more
 * contributor license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright ownership.
 * The ASF licenses this file to You under the Apache License, Version 2.0
 * (the &quot;License&quot;); you may not use this file except in compliance with
 * the License.  You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Contributors:   Mathias Bogaert

package org.apache.log4j.xml;

import org.apache.log4j.Layout;
import org.apache.log4j.helpers.Transform;
import org.apache.log4j.spi.LocationInfo;
import org.apache.log4j.spi.LoggingEvent;

import java.util.Set;
import java.util.Arrays;

/**
 * The output of the XMLLayout consists of a series of log4j:event
 * elements as defined in the &lt;a
 * href=&quot;log4j.dtd&quot;&gt;log4j.dtd&lt;/a&gt;. It does not output a
 * complete well-formed XML file. The output is designed to be
 * included as an &lt;em&gt;external entity&lt;/em&gt; in a separate file to form
 * a correct XML file.
 *
 * &lt;p&gt;For example, if &lt;code&gt;abc&lt;/code&gt; is the name of the file where
 * the XMLLayout ouput goes, then a well-formed XML file would be:
 *
  &lt;pre&gt;
   &amp;lt;?xml version=&quot;1.0&quot; ?&amp;gt;
 
  &amp;lt;!DOCTYPE log4j:eventSet PUBLIC &quot;-//APACHE//DTD LOG4J 1.2//EN&quot; &quot;log4j.dtd&quot; [&amp;lt;!ENTITY data SYSTEM &quot;abc&quot;&amp;gt;]&amp;gt;
 
  &amp;lt;log4j:eventSet version=&quot;1.2&quot; xmlns:log4j=&quot;http://jakarta.apache.org/log4j/&quot;&amp;gt;
 	&amp;nbsp;&amp;nbsp;&amp;data;
  &amp;lt;/log4j:eventSet&amp;gt;
  &lt;/pre&gt;
 
 * &lt;p&gt;This approach enforces the independence of the XMLLayout and the
 * appender where it is embedded.
 *
 * &lt;p&gt;The &lt;code&gt;version&lt;/code&gt; attribute helps components to correctly
 * intrepret output generated by XMLLayout. The value of this
 * attribute should be &quot;1.1&quot; for output generated by log4j versions
 * prior to log4j 1.2 (final release) and &quot;1.2&quot; for relase 1.2 and
 * later.
 *
 * Appenders using this layout should have their encoding
 * set to UTF-8 or UTF-16, otherwise events containing
 * non ASCII characters could result in corrupted
 * log files. 
 *
 * @author Ceki  G&amp;uuml;lc&amp;uuml;
 * @since 0.9.0 
 * */
<span class="fc" id="L68">public class XMLLayout extends Layout {</span>

<span class="fc" id="L70">  private  final int DEFAULT_SIZE = 256;</span>
<span class="fc" id="L71">  private final int UPPER_LIMIT = 2048;</span>

<span class="fc" id="L73">  private StringBuffer buf = new StringBuffer(DEFAULT_SIZE);</span>
<span class="fc" id="L74">  private boolean locationInfo = false;</span>
<span class="fc" id="L75">  private boolean properties = false;</span>
 
  /**
   * The &lt;b&gt;LocationInfo&lt;/b&gt; option takes a boolean value. By default,
   * it is set to false which means there will be no location
   * information output by this layout. If the the option is set to
   * true, then the file name and line number of the statement at the
   * origin of the log statement will be output.
   *
   * &lt;p&gt;If you are embedding this layout within an {@link
   * org.apache.log4j.net.SMTPAppender} then make sure to set the
   * &lt;b&gt;LocationInfo&lt;/b&gt; option of that appender as well.
   * */
  public void setLocationInfo(boolean flag) {
<span class="fc" id="L89">    locationInfo = flag;</span>
<span class="fc" id="L90">  }</span>
  
  /**
     Returns the current value of the &lt;b&gt;LocationInfo&lt;/b&gt; option.
   */
  public boolean getLocationInfo() {
<span class="nc" id="L96">    return locationInfo;</span>
  }

    /**
     * Sets whether MDC key-value pairs should be output, default false.
     * @param flag new value.
     * @since 1.2.15
     */
  public void setProperties(final boolean flag) {
<span class="fc" id="L105">      properties = flag;</span>
<span class="fc" id="L106">  }</span>

    /**
     * Gets whether MDC key-value pairs should be output.
     * @return true if MDC key-value pairs are output.
     * @since 1.2.15
     */
  public boolean getProperties() {
<span class="nc" id="L114">      return properties;</span>
  }

  /** No options to activate. */
  public void activateOptions() {
<span class="nc" id="L119">  }</span>


  /**
   * Formats a {@link org.apache.log4j.spi.LoggingEvent} in conformance with the log4j.dtd.
   * */
  public String format(final LoggingEvent event) {

    // Reset working buffer. If the buffer is too large, then we need a new
    // one in order to avoid the penalty of creating a large array.
<span class="fc bfc" id="L129" title="All 2 branches covered.">    if(buf.capacity() &gt; UPPER_LIMIT) {</span>
<span class="fc" id="L130">      buf = new StringBuffer(DEFAULT_SIZE);</span>
    } else {
<span class="fc" id="L132">      buf.setLength(0);</span>
    }
    
    // We yield to the \r\n heresy.

<span class="fc" id="L137">    buf.append(&quot;&lt;log4j:event logger=\&quot;&quot;);</span>
<span class="fc" id="L138">    buf.append(Transform.escapeTags(event.getLoggerName()));</span>
<span class="fc" id="L139">    buf.append(&quot;\&quot; timestamp=\&quot;&quot;);</span>
<span class="fc" id="L140">    buf.append(event.timeStamp);</span>
<span class="fc" id="L141">    buf.append(&quot;\&quot; level=\&quot;&quot;);</span>
<span class="fc" id="L142">    buf.append(Transform.escapeTags(String.valueOf(event.getLevel())));</span>
<span class="fc" id="L143">    buf.append(&quot;\&quot; thread=\&quot;&quot;);</span>
<span class="fc" id="L144">    buf.append(Transform.escapeTags(event.getThreadName()));</span>
<span class="fc" id="L145">    buf.append(&quot;\&quot;&gt;\r\n&quot;);</span>

<span class="fc" id="L147">    buf.append(&quot;&lt;log4j:message&gt;&lt;![CDATA[&quot;);</span>
    // Append the rendered message. Also make sure to escape any
    // existing CDATA sections.
<span class="fc" id="L150">    Transform.appendEscapingCDATA(buf, event.getRenderedMessage());</span>
<span class="fc" id="L151">    buf.append(&quot;]]&gt;&lt;/log4j:message&gt;\r\n&quot;);       </span>
    
<span class="fc" id="L153">    String ndc = event.getNDC();</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">    if(ndc != null) {</span>
<span class="nc" id="L155">      buf.append(&quot;&lt;log4j:NDC&gt;&lt;![CDATA[&quot;);</span>
<span class="nc" id="L156">      Transform.appendEscapingCDATA(buf, ndc);</span>
<span class="nc" id="L157">      buf.append(&quot;]]&gt;&lt;/log4j:NDC&gt;\r\n&quot;);       </span>
    }
    
<span class="fc" id="L160">    String[] s = event.getThrowableStrRep();</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">    if(s != null) {</span>
<span class="fc" id="L162">      buf.append(&quot;&lt;log4j:throwable&gt;&lt;![CDATA[&quot;);</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">      for(int i = 0; i &lt; s.length; i++) {</span>
<span class="fc" id="L164">          Transform.appendEscapingCDATA(buf, s[i]);</span>
<span class="fc" id="L165">	      buf.append(&quot;\r\n&quot;);</span>
      }
<span class="fc" id="L167">      buf.append(&quot;]]&gt;&lt;/log4j:throwable&gt;\r\n&quot;);</span>
    }
    
<span class="fc bfc" id="L170" title="All 2 branches covered.">    if(locationInfo) { </span>
<span class="fc" id="L171">      LocationInfo locationInfo = event.getLocationInformation();	</span>
<span class="fc" id="L172">      buf.append(&quot;&lt;log4j:locationInfo class=\&quot;&quot;);</span>
<span class="fc" id="L173">      buf.append(Transform.escapeTags(locationInfo.getClassName()));</span>
<span class="fc" id="L174">      buf.append(&quot;\&quot; method=\&quot;&quot;);</span>
<span class="fc" id="L175">      buf.append(Transform.escapeTags(locationInfo.getMethodName()));</span>
<span class="fc" id="L176">      buf.append(&quot;\&quot; file=\&quot;&quot;);</span>
<span class="fc" id="L177">      buf.append(Transform.escapeTags(locationInfo.getFileName()));</span>
<span class="fc" id="L178">      buf.append(&quot;\&quot; line=\&quot;&quot;);</span>
<span class="fc" id="L179">      buf.append(locationInfo.getLineNumber());</span>
<span class="fc" id="L180">      buf.append(&quot;\&quot;/&gt;\r\n&quot;);</span>
    }

<span class="fc bfc" id="L183" title="All 2 branches covered.">    if (properties) {</span>
<span class="fc" id="L184">        Set keySet = event.getPropertyKeySet();</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        if (keySet.size() &gt; 0) {</span>
<span class="fc" id="L186">            buf.append(&quot;&lt;log4j:properties&gt;\r\n&quot;);</span>
<span class="fc" id="L187">            Object[] keys = keySet.toArray();</span>
<span class="fc" id="L188">            Arrays.sort(keys);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">            for (int i = 0; i &lt; keys.length; i++) {</span>
<span class="fc" id="L190">                String key = keys[i].toString();</span>
<span class="fc" id="L191">                Object val = event.getMDC(key);</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">                if (val != null) {</span>
<span class="fc" id="L193">                    buf.append(&quot;&lt;log4j:data name=\&quot;&quot;);</span>
<span class="fc" id="L194">                    buf.append(Transform.escapeTags(key));</span>
<span class="fc" id="L195">                    buf.append(&quot;\&quot; value=\&quot;&quot;);</span>
<span class="fc" id="L196">                    buf.append(Transform.escapeTags(String.valueOf(val)));</span>
<span class="fc" id="L197">                    buf.append(&quot;\&quot;/&gt;\r\n&quot;);</span>
                }
            }
<span class="fc" id="L200">            buf.append(&quot;&lt;/log4j:properties&gt;\r\n&quot;);</span>
        }
    }
    
<span class="fc" id="L204">    buf.append(&quot;&lt;/log4j:event&gt;\r\n\r\n&quot;);</span>
    
<span class="fc" id="L206">    return buf.toString();</span>
  }
  
  /**
     The XMLLayout prints and does not ignore exceptions. Hence the
     return value &lt;code&gt;false&lt;/code&gt;.
  */
  public boolean ignoresThrowable() {
<span class="fc" id="L214">    return false;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>